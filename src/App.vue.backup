<template>
  <!-- Show Login Page if not authenticated -->
  <LoginPage v-if="!isAuthenticated" @login-success="handleLoginSuccess" />

  <!-- Main Application if authenticated -->
  <div v-else class="main-container">
    <!-- Header -->
    <header class="header">
      <img src="/src/assets/basarnas.png" alt="BASARNAS Logo" class="logo">
      <span class="header-title">SISTEM MONITORING KAPAL</span>
      <div class="user-info">
        <span>Selamat datang, {{ currentUser?.name || 'User' }}</span>
        <button @click="handleLogout" class="logout-btn">Logout</button>
      </div>
    </header>
    <div class="grid-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h3 class="sidebar-title">Daftar Kapal</h3>
        <div class="search-row">
          <input v-model="search" placeholder="Cari Nama Kapal" class="search-input">
          <select v-model="searchBy" class="search-select">
            <option value="name">By Name</option>
            <option value="id">By ID</option>
          </select>
          <button class="search-btn">
            <svg width="18" height="18" fill="#6c757d"><circle cx="8" cy="8" r="7" stroke="#6c757d" stroke-width="2" fill="none"/><line x1="13" y1="13" x2="17" y2="17" stroke="#6c757d" stroke-width="2"/></svg>
          </button>
        </div>
        <ul class="ship-list">
          <li v-for="ship in filteredShips" :key="ship.id" @click="focusShip(ship)" class="ship-item">
            <span class="ship-icon" :style="{ color: ship.colorCode }">⛴️</span>
            <div class="ship-info">
              <span class="ship-name">{{ ship.name }}</span>
              <span class="ship-id">{{ ship.id }}</span>
            </div>
          </li>
        </ul>
        <div class="sidebar-footer">
          <span>Total Data</span>
          <span class="total-data">{{ ships.length }}</span>
          <button class="export-btn" @click="exportData">Export</button>
        </div>
      </aside>
      <!-- Map -->
      <div class="map-container">
        <div id="map" ref="mapContainer"></div>
        <div class="waypoint-actions">
          <button v-if="selectedShip" class="waypoint-btn" @click="showWaypointModal = true">Waypoint</button>
          <button v-if="selectedShip" class="waypoint-eta-btn" @click="toggleWaypointETA">
            <img src="/src/assets/flag.png" alt="Waypoint ETA" class="eta-icon">
          </button>
        </div>
        <span class="copyright">Copyright Basarnas © 2025</span>
        <!-- Modal Waypoint -->
        <div v-if="showWaypointModal" class="modal-overlay">
          <div class="modal-content">
            <h3>Tambah Waypoint</h3>
            <form @submit.prevent="addWaypoint">
              <div class="modal-row">
                <div>
                  <label>Nama</label>
                  <input v-model="waypointForm.name" type="text" placeholder="Masukkan identifier waypoint" required>
                </div>
                <div>
                  <label>Latitude, Longitude</label>
                  <input v-model.number="waypointForm.lat" type="number" step="0.000001" placeholder="Latitude" required>
                  <input v-model.number="waypointForm.lng" type="number" step="0.000001" placeholder="Longitude" required>
                </div>
              </div>
              <div class="modal-actions">
                <button type="button" @click="closeWaypointModal" class="cancel-btn">Batal</button>
                <button type="submit" class="save-btn">Simpan</button>
              </div>
            </form>
          </div>
        </div>
        <!-- Waypoint ETA Panel -->
        <div v-if="showWaypointETA && selectedShip" class="waypoint-eta-panel">
          <h4> Waypoint ETA</h4>
          <ul>
            <li v-for="(wp, idx) in waypointSummary" :key="idx">
              <img src="/src/assets/red-flag.png" alt="Waypoint" class="eta-icon">
              <div>
                <strong>{{ wp.name }}</strong><br>
                <small>Jarak: {{ wp.distance }} | ETA: {{ wp.eta }}</small>
              </div>
              <button class="delete-waypoint-btn" @click="removeWaypoint(idx)">Hapus</button>
            </li>
          </ul>
          <button class="close-eta-btn" @click="showWaypointETA = false">Tutup</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import LoginPage from './components/LoginPage.vue'
import L from "leaflet";
import "leaflet/dist/leaflet.css";

export default {
  name: "App",
  components: {
    LoginPage
  },
  data() {
    return {
      isAuthenticated: false,
      currentUser: null,
      map: null,
      search: "",
      searchBy: "name",
      selectedShip: null,
      ships: [
        { id: "3300098", name: "BUMI 330 01", lat: -6.073861, lng: 106.814221, colorCode: "#2ecc40", shipSpeed: 21 },
        { id: "331301", name: "KM PUJI LAKSANA HD", lat: -3.908856, lng: 122.882033, colorCode: "#ff9800", shipSpeed: 25 },
        { id: "3315531", name: "KM MARGO JATI", lat: -8.041664, lng: 115.171890, colorCode: "#2ecc40", shipSpeed: 28 },
        { id: "331639", name: "KM BANDAR NELAYAN-271", lat: -6.723982, lng: 112.669585, colorCode: "#2ecc40", shipSpeed: 22 },
        { id: "3316846", name: "KM BANDAR NELAYAN-275", lat: -3.5, lng: 128.1, colorCode: "#2ecc40", shipSpeed: 30 },
        { id: "3317203", name: "KM CITRA NUSANTARA VII", lat: -2.9, lng: 127.8, colorCode: "#2ecc40", shipSpeed: 24 },
        { id: "3321777", name: "KM GAJAH SAMUDRA-6", lat: -1.2, lng: 124.5, colorCode: "#2ecc40", shipSpeed: 27 },
        { id: "3327507", name: "KM HASIL JAYA", lat: -5.028901, lng: 124.294876, colorCode: "#2ecc40", shipSpeed: 23 },
        { id: "3331738", name: "KM ATLANTIK-3", lat: -4.843626, lng: 121.010154, colorCode: "#2ecc40", shipSpeed: 29 },
      ],
      markers: [],
      showWaypointModal: false,
      showWaypointETA: false,
      waypointForm: {
        name: "",
        lat: "",
        lng: "",
      },
      waypointMarkers: [],
      waypointList: [],
      routeLines: [],
      shipSpeed: 37,
      waypointSummary: [],
    };
  },

  computed: {
    filteredShips() {
      if (this.searchBy === "name") {
        return this.ships.filter((ship) =>
          ship.name.toLowerCase().includes(this.search.toLowerCase())
        );
      } else {
        return this.ships.filter((ship) =>
          ship.id.includes(this.search)
        );
      }
    },
  },

  mounted() {
    this.checkAuthentication()
  },

  methods: {
    checkAuthentication() {
      const isAuthenticated = localStorage.getItem('isAuthenticated')
      const user = localStorage.getItem('user')

      if (isAuthenticated && user) {
        this.isAuthenticated = true
        this.currentUser = JSON.parse(user)
        this.$nextTick(() => {
          this.initMap()
        })
      }
    },

    handleLoginSuccess(user) {
      this.isAuthenticated = true
      this.currentUser = user
      this.$nextTick(() => {
        this.initMap()
      })
    },

    handleLogout() {
      this.isAuthenticated = false
      this.currentUser = null
      localStorage.removeItem('isAuthenticated')
      localStorage.removeItem('user')
      localStorage.removeItem('authToken')

      if (this.map) {
        this.map.remove()
        this.map = null
      }
    },

    initMap() {
      if (this.map) return

      this.map = L.map(this.$refs.mapContainer, {
        zoomControl: true,
        attributionControl: false,
      }).setView([-2, 118], 5);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(this.map);

      this.addShipMarkers();
      L.control.scale().addTo(this.map);
    },

    addShipMarkers() {
      if (!this.map) return

      this.markers.forEach(marker => {
        this.map.removeLayer(marker);
      });
      this.markers = [];

      this.ships.forEach((ship) => {
        const customIcon = L.divIcon({
          className: 'custom-ship-icon',
          html: `<div style="background-color: ${ship.colorCode}; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">⛴️</div>`,
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        });

        const marker = L.marker([ship.lat, ship.lng], { icon: customIcon }).addTo(this.map);

        marker.bindPopup(`
          <div style="font-family: Arial, sans-serif; line-height: 1.4;">
            <h4 style="margin: 0 0 8px 0; color: #1e3a8a;">${ship.name}</h4>
            <p style="margin: 4px 0;"><strong>ID:</strong> ${ship.id}</p>
            <p style="margin: 4px 0;"><strong>Kecepatan:</strong> ${ship.shipSpeed} knots</p>
            <p style="margin: 4px 0;"><strong>Posisi:</strong> ${ship.lat.toFixed(4)}, ${ship.lng.toFixed(4)}</p>
          </div>
        `);

        marker.on('click', () => {
          this.selectedShip = ship;
        });

        this.markers.push(marker);
      });

      if (this.markers.length > 0) {
        const group = new L.featureGroup(this.markers);
        this.map.fitBounds(group.getBounds().pad(0.1));
      }
    },

    focusShip(ship) {
      if (!this.map) return

      this.selectedShip = ship;
      this.map.setView([ship.lat, ship.lng], 10);

      const marker = this.markers.find(m => {
        const latlng = m.getLatLng();
        return latlng.lat === ship.lat && latlng.lng === ship.lng;
      });

      if (marker) {
        marker.openPopup();
      }
    },

    toggleWaypointETA() {
      this.showWaypointETA = !this.showWaypointETA;
      if (this.showWaypointETA && this.selectedShip) {
        this.calculateWaypointETA();
      }
    },

    addWaypoint() {
      if (!this.selectedShip || !this.waypointForm.name || !this.waypointForm.lat || !this.waypointForm.lng) {
        return;
      }

      const waypoint = {
        name: this.waypointForm.name,
        lat: parseFloat(this.waypointForm.lat),
        lng: parseFloat(this.waypointForm.lng),
        shipId: this.selectedShip.id,
      };

      this.waypointList.push(waypoint);

      const waypointIcon = L.icon({
        iconUrl: '/src/assets/flag.png',
        iconSize: [25, 25],
        iconAnchor: [12, 25],
        popupAnchor: [0, -25],
      });

      const waypointMarker = L.marker([waypoint.lat, waypoint.lng], { icon: waypointIcon })
        .addTo(this.map)
        .bindPopup(`<strong>${waypoint.name}</strong><br/>${waypoint.lat}, ${waypoint.lng}`);

      this.waypointMarkers.push(waypointMarker);
      this.drawRoute();
      this.waypointForm = { name: "", lat: "", lng: "" };
      this.closeWaypointModal();
      this.calculateWaypointETA();
    },

    drawRoute() {
      this.routeLines.forEach(line => {
        this.map.removeLayer(line);
      });
      this.routeLines = [];

      if (this.waypointList.length < 2) return;

      const sortedWaypoints = [...this.waypointList];
      const latlngs = sortedWaypoints.map(wp => [wp.lat, wp.lng]);

      const routeLine = L.polyline(latlngs, {
        color: 'blue',
        weight: 3,
        opacity: 0.7,
        dashArray: '10, 10',
      }).addTo(this.map);

      this.routeLines.push(routeLine);
    },

    calculateWaypointETA() {
      if (!this.selectedShip || this.waypointList.length === 0) return;

      this.waypointSummary = this.waypointList.map((waypoint, index) => {
        const distance = this.calculateDistance(
          this.selectedShip.lat,
          this.selectedShip.lng,
          waypoint.lat,
          waypoint.lng
        );

        const timeHours = distance / this.selectedShip.shipSpeed;
        const eta = new Date(Date.now() + timeHours * 60 * 60 * 1000);

        return {
          name: waypoint.name,
          distance: `${distance.toFixed(2)} km`,
          eta: eta.toLocaleString('id-ID', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }),
        };
      });
    },

    calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = this.toRadians(lat2 - lat1);
      const dLng = this.toRadians(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    },

    toRadians(degrees) {
      return degrees * (Math.PI / 180);
    },

    removeWaypoint(index) {
      const waypoint = this.waypointList[index];
      this.waypointList.splice(index, 1);

      const markerIndex = this.waypointMarkers.findIndex(marker => {
        const latlng = marker.getLatLng();
        return latlng.lat === waypoint.lat && latlng.lng === waypoint.lng;
      });

      if (markerIndex !== -1) {
        this.map.removeLayer(this.waypointMarkers[markerIndex]);
        this.waypointMarkers.splice(markerIndex, 1);
      }

      this.drawRoute();
      this.calculateWaypointETA();
    },

    closeWaypointModal() {
      this.showWaypointModal = false;
      this.waypointForm = { name: "", lat: "", lng: "" };
    },

    exportData() {
      const data = {
        ships: this.ships,
        waypoints: this.waypointList,
        exportDate: new Date().toISOString(),
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ship-monitoring-data-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    },
  },
};
</script>
    <div class="grid-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h3 class="sidebar-title">Daftar Kapal</h3>
        <div class="search-row">
          <input v-model="search" placeholder="Cari Nama Kapal" class="search-input" />
          <select v-model="searchBy" class="search-select">
            <option value="name">By Name</option>
            <option value="id">By ID</option>
          </select>
          <button class="search-btn">
            <svg width="18" height="18" fill="#6c757d"><circle cx="8" cy="8" r="7" stroke="#6c757d" stroke-width="2" fill="none"/><line x1="13" y1="13" x2="17" y2="17" stroke="#6c757d" stroke-width="2"/></svg>
          </button>
        </div>
        <ul class="ship-list">
          <li v-for="ship in filteredShips" :key="ship.id" @click="focusShip(ship)" class="ship-item">
            <span class="ship-icon" :style="{ color: ship.colorCode }">⛴️</span>
            <div class="ship-info">
              <span class="ship-name">{{ ship.name }}</span>
              <span class="ship-id">{{ ship.id }}</span>
            </div>
          </li>
        </ul>
        <div class="sidebar-footer">
          <span>Total Data</span>
          <span class="total-data">{{ ships.length }}</span>
          <button class="export-btn" @click="exportData">Export</button>
        </div>
      </aside>
      <!-- Map -->
      <div class="map-container">
        <div id="map" ref="mapContainer"></div>
        <div class="waypoint-actions">
          <button v-if="selectedShip" class="waypoint-btn" @click="showWaypointModal = true">Waypoint</button>
          <button v-if="selectedShip" class="waypoint-eta-btn" @click="toggleWaypointETA">
            <img src="/src/assets/flag.png" alt="Waypoint ETA" class="eta-icon" />
          </button>
        </div>
        <span class="copyright">Copyright Basarnas © 2025</span>
        <!-- Modal Waypoint -->
        <div v-if="showWaypointModal" class="modal-overlay">
          <div class="modal-content">
            <h3>Tambah Waypoint</h3>
            <form @submit.prevent="addWaypoint">
              <div class="modal-row">
                <div>
                  <label>Nama</label>
                  <input v-model="waypointForm.name" type="text" placeholder="Masukkan identifier waypoint" required />
                </div>
                <div>
                  <label>Latitude, Longitude</label>
                  <input v-model.number="waypointForm.lat" type="number" step="0.000001" placeholder="Latitude" required />
                  <input v-model.number="waypointForm.lng" type="number" step="0.000001" placeholder="Longitude" required />
                </div>
              </div>
              <div class="modal-actions">
                <button type="button" @click="closeWaypointModal" class="cancel-btn">Batal</button>
                <button type="submit" class="save-btn">Simpan</button>
              </div>
            </form>
          </div>
        </div>
        <!-- Waypoint ETA Panel -->
        <div v-if="showWaypointETA && selectedShip" class="waypoint-eta-panel">
          <h4> Waypoint ETA</h4>
          <ul>
            <li v-for="(wp, idx) in waypointSummary" :key="idx">
              <img src="/src/assets/red-flag.png" alt="Waypoint" class="eta-icon" />
              <div>
                <strong>{{ wp.name }}</strong><br/>
                <small>Jarak: {{ wp.distance }} | ETA: {{ wp.eta }}</small>
              </div>
              <button class="delete-waypoint-btn" @click="removeWaypoint(idx)">Hapus</button>
            </li>
          </ul>
          <button class="close-eta-btn" @click="showWaypointETA = false">Tutup</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import L from "leaflet";
import "leaflet/dist/leaflet.css";

import kapalIcon from "./assets/kapal.png";
import redFlagIcon from "./assets/red-flag.png";
import flagIcon from "./assets/flag.png";

export default {
  name: "App",
  data() {
    return {
      map: null,
      search: "",
      searchBy: "name",
        selectedShip: null, // kapal yang dipilih user
        ships: [
      { id: "3300098", name: "BUMI 330 01", lat: -6.073861, lng: 106.814221, colorCode: "#2ecc40", shipSpeed: 21 },
      { id: "331301", name: "KM PUJI LAKSANA HD", lat: -3.908856, lng: 122.882033, colorCode: "#ff9800", shipSpeed: 25 },
      { id: "3315531", name: "KM MARGO JATI", lat: -8.041664, lng: 115.171890, colorCode: "#2ecc40", shipSpeed: 28 },
      { id: "331639", name: "KM BANDAR NELAYAN-271", lat: -6.723982, lng: 112.669585, colorCode: "#2ecc40", shipSpeed: 22 },
      { id: "3316846", name: "KM BANDAR NELAYAN-275", lat: -3.5, lng: 128.1, colorCode: "#2ecc40", shipSpeed: 30 },
      { id: "3317203", name: "KM CITRA NUSANTARA VII", lat: -2.9, lng: 127.8, colorCode: "#2ecc40", shipSpeed: 24 },
      { id: "3321777", name: "KM GAJAH SAMUDRA-6", lat: -1.2, lng: 124.5, colorCode: "#2ecc40", shipSpeed: 27 },
      { id: "3327507", name: "KM HASIL JAYA", lat: -5.028901, lng: 124.294876, colorCode: "#2ecc40", shipSpeed: 23 },
      { id: "3331738", name: "KM ATLANTIK-3", lat: -4.843626, lng: 121.010154, colorCode: "#2ecc40", shipSpeed: 29 },
        ],
      markers: [],
      showWaypointModal: false,
      showWaypointETA: false,
      waypointForm: {
        name: "",
        lat: "",
        lng: "",
      },
      waypointMarkers: [],
      waypointList: [],
      routeLines: [], // untuk simpan polyline
      shipSpeed: 37, // km/h (asumsi default)
      waypointSummary: [],
    };
  },
  
  computed: {
    filteredShips() {
      if (this.searchBy === "name") {
        return this.ships.filter((ship) =>
          ship.name.toLowerCase().includes(this.search.toLowerCase())
        );
      } else {
        return this.ships.filter((ship) =>
          ship.id.includes(this.search)
        );
      }
    },
  },
  mounted() {
    this.map = L.map(this.$refs.mapContainer, {
      zoomControl: true,
      attributionControl: false,
    }).setView([-2, 118], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "",
    }).addTo(this.map);

    // Tambahkan skala di pojok kiri bawah
    L.control.scale({ position: "bottomleft", metric: true, imperial: false }).addTo(this.map);

    this.renderShips();
  },
  methods: {
    renderShips() {
      this.markers.forEach((m) => this.map.removeLayer(m));
      this.markers = [];
      this.filteredShips.forEach((ship) => {
        const marker = L.marker([ship.lat, ship.lng], {
          icon: this.shipIcon(ship.colorCode),
        }).addTo(this.map);
        marker.bindPopup(`<b>${ship.name}</b><br>ID: ${ship.id}`);
        marker.on('popupclose', () => {
          this.clearSelectedShip();
        });
        marker.on('click', () => {
          this.focusShip(ship);
        });
        this.markers.push(marker);
      });
    },
    focusShip(ship) {
      // Jika kapal diganti, hapus semua waypoint & garis sebelumnya
      if (!this.selectedShip || this.selectedShip.id !== ship.id) {
        this.clearWaypoints();
      }
      this.selectedShip = ship;
      this.map.setView([ship.lat, ship.lng], 8);

      const marker = this.markers.find(
        (m) => m.getLatLng().lat === ship.lat && m.getLatLng().lng === ship.lng
      );
      if (marker) marker.openPopup();

      this.updateRouteSummary();
      this.showWaypointETA = this.waypointList.length > 0;
      this.updateRouteLines();
    },
    clearSelectedShip() {
      this.selectedShip = null;
      this.showWaypointETA = false;
      this.clearWaypoints();
      this.routeLines.forEach((line) => this.map.removeLayer(line));
      this.routeLines = [];
    },
    clearWaypoints() {
      this.waypointMarkers.forEach((m) => this.map.removeLayer(m));
      this.waypointMarkers = [];
      this.waypointList = [];
      this.waypointSummary = [];
    },
    addWaypoint() {
      if (!this.selectedShip) return; // Tidak bisa tambah waypoint jika belum pilih kapal
      let { name, lat, lng } = this.waypointForm;
      lat = Number(lat);
      lng = Number(lng);

      if (!name || isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        alert("Latitude dan Longitude harus valid!");
        return;
      }

      const marker = L.marker([lat, lng], { icon: this.waypointIcon() }).addTo(this.map);
      marker.bindPopup(`<b>${name}</b><br>Lat: ${lat}<br>Lng: ${lng}`);
      this.waypointMarkers.push(marker);
      this.waypointList.push({ name, lat, lng });

      this.closeWaypointModal();
      this.map.setView([lat, lng], 10);
      this.updateRouteSummary();
      this.showWaypointETA = true;
      this.updateRouteLines();
    },
    removeWaypoint(index) {
      const marker = this.waypointMarkers[index];
      if (marker) {
        this.map.removeLayer(marker);
        this.waypointMarkers.splice(index, 1);
      }
      this.waypointList.splice(index, 1);
      this.updateRouteSummary();
      this.updateRouteLines();
    },
    // Haversine formula untuk hitung jarak km
    calcDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c; // km
    },
    updateRouteSummary() {
      if (!this.selectedShip) {
        this.waypointSummary = [];
        return;
      }
      this.waypointSummary = this.waypointList.map((wp, idx) => {
        let fromLat = idx === 0 ? this.selectedShip.lat : this.waypointList[idx - 1].lat;
        let fromLng = idx === 0 ? this.selectedShip.lng : this.waypointList[idx - 1].lng;
        const dist = this.calcDistance(fromLat, fromLng, wp.lat, wp.lng);
        const time = dist / this.selectedShip.shipSpeed;
        const hrs = Math.floor(time);
        const mins = Math.round((time - hrs) * 60);
        return {
          ...wp,
          distance: dist.toFixed(2) + " km",
          eta: `${hrs}h ${mins}m`
        };
      });
    },
    updateRouteLines() {
      // hapus garis lama
      this.routeLines.forEach((line) => this.map.removeLayer(line));
      this.routeLines = [];

      if (!this.selectedShip || this.waypointList.length === 0) return;

      let coords = [[this.selectedShip.lat, this.selectedShip.lng]];
      this.waypointList.forEach((wp) => {
        coords.push([wp.lat, wp.lng]);
      });

      const polyline = L.polyline(coords, {
        color: "blue",
        weight: 2,
        dashArray: "6,6"
      }).addTo(this.map);

      this.routeLines.push(polyline);
    },
    closeWaypointModal() {
      this.showWaypointModal = false;
      this.waypointForm = { name: "", lat: "", lng: "" };
    },
    toggleWaypointETA() {
      this.showWaypointETA = !this.showWaypointETA;
    },
    waypointIcon() {
      // Icon bendera merah
      return new L.Icon({
        iconUrl: redFlagIcon,
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32],
        shadowUrl: "",
        shadowSize: [0, 0],
        className: "",
      });
    },
    exportData() {
      alert("Export data kapal (mock)");
    },
    shipIcon(color) {
      return new L.Icon({
        iconUrl:
          color === "#ff9800"
            ? kapalIcon
            : kapalIcon,
        iconSize: [20, 32],
        iconAnchor: [10, 32],
        popupAnchor: [1, -32],
        shadowUrl:
          "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
        shadowSize: [32, 32],
        className: "",
      });
    },
  },
  watch: {
    search() {
      this.renderShips();
    },
    searchBy() {
      this.renderShips();
    },
  },
  
};
</script>

<style>
body {
  background: #f3f8fa;
  font-family: 'Inter', Arial, sans-serif;
}
.main-container {
  background: #f3f8fa;
  min-height: 100vh;
  width: 100vw;
}
.header {
  display: flex;
  align-items: center;
  background: #fff;
  border-radius: 20px;
  margin: 20px 32px 0 32px;
  padding: 16px 32px;
  box-shadow: 0 2px 12px #e3e3e3;
  width: calc(100% - 64px);
  max-width: none;
  height: 80px;
}
.logo {
  width: 48px;
  height: 48px;
  margin-right: 18px;
  border-radius: 12px;
  background: #f3f8fa;
  object-fit: contain;
  border: 1px solid #e3e3e3;
}
.header-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #222;
  letter-spacing: 1px;
}
.grid-layout {
  display: grid;
  grid-template-columns: 340px 1fr;
  grid-template-rows: 1fr;
  gap: 20px;
  height: calc(100vh - 120px);
  margin: 20px 32px 32px 32px;
}
.sidebar {
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 2px 8px #e3e3e3;
  padding: 16px 12px 12px 12px;
  display: flex;
  flex-direction: column;
  min-width: 0;
  height: 100%;
  position: sticky;
  top: 0;
}
.sidebar-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #222;
  margin-bottom: 10px;
  text-align: center;
}
.search-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
}
.search-input {
  flex: 1;
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid #e3e3e3;
  background: #f3f8fa;
  color: #222;
  font-size: 0.98rem;
}
.search-select {
  padding: 5px 8px;
  border-radius: 8px;
  border: 1px solid #e3e3e3;
  background: #f3f8fa;
  color: #222;
  font-size: 0.95rem;
}
.search-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
}
.ship-list {
  list-style: none;
  padding: 0;
  margin: 0;
  flex: 1;
  overflow-y: auto;
  max-height: calc(100vh - 260px);
}
.ship-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;
  border-bottom: 1px solid #e3e3e3;
  cursor: pointer;
  transition: background 0.2s;
}
.ship-item:hover {
  background: #f3f8fa;
}
.ship-icon {
  font-size: 1.3rem;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.ship-info {
  display: flex;
  flex-direction: column;
}
.ship-name {
  font-weight: 600;
  color: #222;
  font-size: 1rem;
}
.ship-id {
  font-size: 0.93rem;
  color: #888;
}
.sidebar-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 12px;
  font-size: 0.98rem;
  color: #222;
}
.total-data {
  font-weight: 600;
  margin-left: 8px;
}
.export-btn {
  background: #e3f7e3;
  color: #2ecc40;
  border: none;
  border-radius: 8px;
  padding: 5px 16px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 1px 4px #e3e3e3;
  transition: background 0.2s;
  font-size: 0.98rem;
}
.export-btn:hover {
  background: #c8f7c5;
}
.map-container {
  position: relative;
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 2px 8px #e3e3e3;
  height: 100%;
  display: flex;
  flex-direction: column;
}
#map {
  flex: 1;
  width: 100%;
  height: 100%;
  min-height: 100%;
  border-radius: 20px;
}
.copyright {
  position: absolute;
  right: 24px;
  bottom: 16px;
  font-size: 1rem;
  color: #888;
  background: rgba(255,255,255,0.85);
  padding: 6px 18px;
  border-radius: 12px;
  z-index: 999; /* pastikan lebih tinggi dari peta */
}
.waypoint-actions {
  position: absolute;
  right: 24px;
  bottom: 56px;
  display: flex;
  gap: 10px;
  z-index: 1000;
}
.waypoint-btn {
  background: #222;
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 10px 22px;
  font-size: 1rem;
  font-weight: 600;
  box-shadow: 0 2px 8px #e3e3e3;
  cursor: pointer;
  opacity: 0.95;
}
.waypoint-btn:hover {
  background: #444;
}
.waypoint-eta-btn {
  background: #fff;
  color: #222;
  border: 1px solid #e3e3e3;
  border-radius: 12px;
  padding: 10px 18px 10px 10px;
  font-size: 1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 8px #e3e3e3;
  cursor: pointer;
}
.waypoint-eta-btn:hover {
  background: #f3f8fa;
}
.eta-icon {
  width: 22px;
  height: 22px;
}
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-content {
  background: #fff;
  border-radius: 16px;
  padding: 32px 32px 24px 32px;
  min-width: 420px;
  box-shadow: 0 2px 24px rgba(0,0,0,0.12);
}
.modal-content h3 {
  margin-bottom: 18px;
  font-size: 1.2rem;
  font-weight: 600;
  color: #222; /* warna hitam */
}
.modal-row {
  display: flex;
  gap: 24px;
  margin-bottom: 18px;
}
.modal-row label {
  display: block;
  font-size: 1rem;
  font-weight: 500;
  margin-bottom: 6px;
}
.modal-row input {
  color: #222; /* warna hitam untuk teks input */
  background: #f3f8fa;
  display: block;
  margin-bottom: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #e3e3e3;
  font-size: 1rem;
  width: 180px;
}
.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}
.cancel-btn {
  background: #eee;
  color: #222;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-weight: 500;
  cursor: pointer;
}
.save-btn {
  background: #222;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-weight: 600;
  cursor: pointer;
}
.save-btn:hover {
  background: #444;
}
.waypoint-eta-panel {
  position: absolute;
  right: 24px;
  bottom: 110px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 2px 12px #e3e3e3;
  padding: 18px 22px;
  min-width: 260px;
  z-index: 1001;
  color: #222;
}
.waypoint-eta-panel h4 {
  font-size: 1.08rem;
  font-weight: 600;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.waypoint-eta-panel ul {
  list-style: none;
  padding: 0;
  margin: 0 0 12px 0;
}
.waypoint-eta-panel li {
  margin-bottom: 10px;
  font-size: 0.98rem;
  display: flex;
  align-items: center;
  gap: 8px;
}
.close-eta-btn {
  background: #eee;
  color: #222;
  border: none;
  border-radius: 8px;
  padding: 6px 16px;
  font-weight: 500;
  cursor: pointer;
  font-size: 0.95rem;
}
.close-eta-btn:hover {
  background: #ddd;
}
.delete-waypoint-btn {
  background: #ffcccc;
  color: #d9534f;
  border: none;
  border-radius: 8px;
  padding: 4px 12px;
  font-weight: 500;
  cursor: pointer;
  font-size: 0.9rem;
  margin-left: auto;
}
.delete-waypoint-btn:hover {
  background: #f2b2b2;
}
.close-ship-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #ffdddd;
  color: #d9534f;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  transition: background 0.2s;
  z-index: 1002;
}
.close-ship-btn:hover {
  background: #f2b2b2;
}
</style>
